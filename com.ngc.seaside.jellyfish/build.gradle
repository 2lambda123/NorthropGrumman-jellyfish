apply plugin: 'com.ngc.seaside.application'

configurations {
    commandTemplate
}

dependencies {
    api project(':jellyfish.api')

    implementation "com.ngc.seaside:systemdescriptor.service.impl.xtext:$jellyfishEXTVersion"
    implementation "com.ngc.blocs:service.log.impl.common.logservice:$blocsVersion"
    implementation "com.ngc.blocs:service.resource.impl.common.resourceservice:$blocsVersion"

    implementation "org.osgi:osgi.core:$osgiVersion"
    implementation "org.osgi:osgi.enterprise:$osgiVersion"
    implementation "com.google.inject:guice:$guiceVersion"

    runtimeOnly project(':jellyfish.impl.provider')
    runtimeOnly "com.ngc.seaside:systemdescriptor.scenario.impl.standardsteps:$jellyfishEXTVersion"

    runtimeOnly project(':jellyfish.cli.command.validate')

    runtimeOnly project(':jellyfish.cli.command.samplecommand')
    commandTemplate project(path: ':jellyfish.cli.command.samplecommand', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavadistribution')
    commandTemplate project(path: ':jellyfish.cli.command.createjavadistribution', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjellyfishcommand')
    commandTemplate project(path: ':jellyfish.cli.command.createjellyfishcommand', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createdomain')
    commandTemplate project(path: ':jellyfish.cli.command.createdomain', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createprotocolbuffermessages')
    commandTemplate project(path: ':jellyfish.cli.command.createprotocolbuffermessages', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjellyfishgradleproject')
    commandTemplate project(path: ':jellyfish.cli.command.createjellyfishgradleproject', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavaevents')
    commandTemplate project(path: ':jellyfish.cli.command.createjavaevents', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavapubsubconnector')
    commandTemplate project(path: ':jellyfish.cli.command.createjavapubsubconnector', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.report.requirementsverification')
    commandTemplate project(path: ':jellyfish.cli.command.report.requirementsverification', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.report.requirementsallocation')
    commandTemplate project(path: ':jellyfish.cli.command.report.requirementsallocation', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavaservice')
    commandTemplate project(path: ':jellyfish.cli.command.createjavaservice', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavaserviceproject')
    commandTemplate project(path: ':jellyfish.cli.command.createjavaserviceproject', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavaservicebase')
    commandTemplate project(path: ':jellyfish.cli.command.createjavaservicebase', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavaserviceconfig')
    commandTemplate project(path: ':jellyfish.cli.command.createjavaserviceconfig', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.cli.command.createjavacucumbertests')
    commandTemplate project(path: ':jellyfish.cli.command.createjavacucumbertests', configuration: 'commandTemplate')

    runtimeOnly project(':jellyfish.service.name.impl.namingservices')
    runtimeOnly project(':jellyfish.service.codegen.impl.codegenservices')
    runtimeOnly project(':jellyfish.service.scenario.impl.scenarioservice')
    runtimeOnly project(':jellyfish.service.data.impl.dataservice')
    runtimeOnly project(':jellyfish.service.config.impl.transportconfigurationservice')
    runtimeOnly project(':jellyfish.service.requirements.impl.requirementsservice')
    runtimeOnly project(':jellyfish.service.feature.impl.featureservice')

    runtimeOnly "com.ngc.seaside:guice.modules:$bootstrapVersion"
    runtimeOnly "com.ngc.seaside:bootstrap.service.impl.parameterservice:$bootstrapVersion"
    runtimeOnly "com.ngc.seaside:bootstrap.service.impl.promptuserservice:$bootstrapVersion"
    runtimeOnly "com.ngc.seaside:bootstrap.service.impl.propertyservice:$bootstrapVersion"
    runtimeOnly "com.ngc.seaside:bootstrap.service.impl.repositoryservice:$bootstrapVersion"
    runtimeOnly "com.ngc.seaside:bootstrap.service.impl.templateservice:$bootstrapVersion"

    testImplementation "junit:junit:$junitVersion"
    testImplementation "org.mockito:mockito-core:$mockitoVersion"
}

/**
 * Copy the archive to the distribution directory and rename it to contain the groupId prefix.
 */
task copyCommandTemplate(type: Copy) {
    from configurations.commandTemplate {
        rename { name ->
            def artifacts = configurations.commandTemplate.resolvedConfiguration.resolvedArtifacts
            def artifact = artifacts.find { it.file.name == name }
            "${artifact.moduleVersion.id.group}.${artifact.name}-${artifact.moduleVersion.id.version}-${artifact.classifier}.${artifact.extension}"
        }
    }
    into "${buildDir}/commands-templates/templates/"
}

seasideApplication {
    mainClassName = 'com.ngc.seaside.jellyfish.JellyFish'
    includeDistributionDirs = ['src/main/resources/', "$buildDir/commands-templates/"]
    appHomeVarName = 'appHome'
    appSystemProperties = [NG_FW_HOME: "APP_HOME_VAR"]
    distributionName = "${project.name}-${project.version}"
    installationDir = "build/distributions/${project.name}-${project.version}"

    windows {
        appHomeCmd = "%~dp0.."
    }
    unix {
        appHomeCmd = "pwd -P"
    }
}

copyApplicationResources {
    dependsOn copyCommandTemplate
}

