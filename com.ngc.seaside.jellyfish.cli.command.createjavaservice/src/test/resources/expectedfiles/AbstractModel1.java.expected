package com.ngc.seaside.test1.model1.base.impl;

import com.google.common.base.Preconditions;

import com.ngc.blocs.api.IContext;
import com.ngc.blocs.api.IStatus;
import com.ngc.blocs.service.api.IServiceModule;
import com.ngc.blocs.service.api.ServiceStatus;
import com.ngc.blocs.service.event.api.IEvent;
import com.ngc.blocs.service.event.api.IEventService;
import com.ngc.blocs.service.event.api.Subscriber;
import com.ngc.blocs.service.log.api.ILogService;
import com.ngc.seaside.service.fault.api.IFaultManagementService;
import com.ngc.seaside.service.fault.api.ServiceFaultException;
import com.ngc.seaside.test1.model1.api.IModel1;
import com.ngc.seaside.test1.model1.events.Data1;
import com.ngc.seaside.test1.model1.events.Data3;
import com.ngc.seaside.test1.model1.events.Data5Data;
import com.ngc.seaside.test1.model1.events.Data2;
import com.ngc.seaside.test1.model1.events.Data4;

/**
 * Base class for model 1 implementations.
 */
public abstract class AbstractModel1 implements IServiceModule, IModel1 {

   public final static String NAME = "service:com.ngc.seaside.test1.Model1";

   /**
    * BLoCS boilerplate.
    */
   protected IContext context;
   /**
    * BLoCS boilerplate.
    */
   protected ServiceStatus status = ServiceStatus.DEACTIVATED;

   protected IEventService eventService;

   protected ILogService logService;

   protected IFaultManagementService faultManagementService;

   @Subscriber(Data1.TOPIC_NAME)
   public void receiveData1(IEvent<Data1> event) {
      Preconditions.checkNotNull(event, "event may not be null!");
      try {
         publishData2(scenarioBehavior(event.getSource()));
      } catch (ServiceFaultException fault) {
         logService.error(
               getClass(),
               "Invocation of '%s.calculateData2(Data1)' generated fault, dispatching to fault"
               + " management service.",
               getClass().getName());
         faultManagementService.handleFault(fault);
         // Consume exception.
      }
   }

   @Override
   public String getName() {
      return NAME;
   }

   @Override
   public IContext getContext() {
      return context;
   }

   @Override
   public void setContext(IContext iContext) {
      this.context = iContext;
   }

   @Override
   public IStatus<ServiceStatus> getStatus() {
      return status;
   }

   @Override
   public boolean setStatus(IStatus<ServiceStatus> iStatus) {
      Preconditions.checkNotNull(iStatus, "iStatus may not be null!");
      this.status = iStatus.getStatus();
      return true;
   }

   protected void activate() {
      eventService.addSubscriber(this);
      setStatus(ServiceStatus.ACTIVATED);
      logService.info(getClass(), "activated");
   }

   protected void deactivate() {
      eventService.removeSubscriber(this);
      setStatus(ServiceStatus.DEACTIVATED);
      logService.info(getClass(), "deactivated");
   }

   public void setLogService(ILogService ref) {
      this.logService = ref;
   }

   public void removeLogService(ILogService ref) {
      setLogService(null);
   }

   public void setEventService(IEventService ref) {
      this.eventService = ref;
   }

   public void removeEventService(IEventService ref) {
      setEventService(null);
   }

   public void setFaultManagementService(IFaultManagementService ref) {
      this.faultManagementService = ref;
   }

   public void removeFaultManagementService(IFaultManagementService ref) {
      setFaultManagementService(null);
   }

   /**
    * Publishes the given {@code Data2} object.
    *
    * @param data2 the {@code Data2} to publish
    */
   private void publishData2(Data2 data2) {
      Preconditions.checkNotNull(data2, "data2 may not be null!");
      eventService.publish(data2, Data2.TOPIC);
   }
}
